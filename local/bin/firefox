#!/bin/sh

#
# ~/local/bin/firefox
#

CMD="/usr/bin/firefox"
FLATPAK="$(which flatpak 2>/dev/null)"
FLATPAKERRMSG=""
PKG="org.mozilla.firefox"
PDATA="$HOME/.mozilla"
PTEMPFILE="$HOME/.ffrun"

do_error() {
	printf "\ninstall a package that supplies \"%s\"\n" "$CMD"

	if [ -n "$FLATPAKERRMSG" ]
	then
		printf "%s\n\n" "$FLATPAKERRMSG"
	else
		printf "\n"
	fi

	exit 127
}

launch_program() {
	if ! $CMD "$@" 2>/dev/null
	then
		do_error
	fi
}

default() {
	if ! env | grep -q DISPLAY
	then
		printf "\nNot in a graphical session\n\n"
		exit 1
	else
		launch_program "$@"
	fi
}

if ! [ -x "$CMD" ]
then
	if [ -n "$FLATPAK" ]
	then
		if $FLATPAK list | grep -q "$PKG"
		then
			CMD="$FLATPAK run $PKG"
		else
			FLATPAKERRMSG="or install from flatpak repo with \"$FLATPAK install $PKG\""
		fi
	fi
fi

case "$1" in
	"copy" )
		browser_profile_to_tmpfs copy "$PDATA" "$PTEMPFILE"
		;;
	"clean" )
		browser_profile_to_tmpfs clean "$PDATA" "$PTEMPFILE"
		;;
	"recover" )
		browser_profile_to_tmpfs recover "$PDATA" "$PTEMPFILE"
		;;
	"sync" )
		browser_profile_to_tmpfs sync "$PDATA" "$PTEMPFILE"
		;;
	* )
		default "$@"
		;;
esac
